{"version":3,"file":"Bridge.js","sourceRoot":"","sources":["../../src/browser/Bridge.ts"],"names":[],"mappings":"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","sourcesContent":["import Emitter from '../utils/Emitter.js'\r\nimport { PromiseController } from '../utils/PromiseController.js'\r\nimport { is } from 'typescript-is'\r\nimport type { AppInfo, PostMessageOptions } from '../types'\r\n\r\ntype ChannelController = {\r\n\twindow?: Window | null,\r\n\tpromise?: Promise<unknown>,\r\n\tresolve?: (value?: unknown) => void,\r\n\treject?: (value?: unknown) => void,\r\n}\r\n\r\nexport type Emitting = {\r\n\tmessage: {\r\n\t\tmethod: string\r\n\t\tparams: unknown\r\n\t\tsession?: number | string | undefined // todo remove\r\n\t}\r\n\tbuiltin: { usePopup: boolean }\r\n\t| { requirePopup: boolean }\r\n\t| { keepPopup: boolean }\r\n\t| { showIframe: boolean }\r\n}\r\n\r\nconst WIDTH = '400'\r\nconst HEIGHT = '600'\r\n\r\nexport default class Bridge extends Emitter<Emitting> {\r\n\tprivate _url: URL\r\n\tprivate _iframeParentNode?: Node\r\n\tprivate _iframeNode?: HTMLElement | null\r\n\tprivate _iframeEl?: HTMLIFrameElement | null\r\n\tprivate _iframe: ChannelController = {}\r\n\tprivate _showIframe = false\r\n\tprivate _popup: ChannelController = {}\r\n\tprivate _usePopup = true\r\n\tprivate _requirePopup = false\r\n\tprivate _keepPopup = false\r\n\tprivate _promiseController = new PromiseController()\r\n\tprivate _pending: number[] = []\r\n\r\n\tget url() { return this._url?.origin }\r\n\tget showIframe() { return this._showIframe }\r\n\tset showIframe(value) {\r\n\t\tif (value === this._showIframe) { return }\r\n\t\tthis._showIframe = value\r\n\t\tthis.deliverMessage({ method: 'showIframe', params: value })\r\n\t\tthis.emit('builtin', { showIframe: value })\r\n\t\tif (!this._iframeNode) { return }\r\n\t\tif (!this._iframeParentNode) {\r\n\t\t\tthis._iframeNode.style.opacity = value ? '1' : '0'\r\n\t\t\tthis._iframeNode.style.pointerEvents = value ? '' : 'none'\r\n\t\t\tthis._iframeNode.style.touchAction = value ? '' : 'none'\r\n\t\t\tthis._iframeNode.style.zIndex = value ? '1000000' : '-1000000'\r\n\t\t\tthis._iframeNode.style.transform = value ? '' : 'translate(0, 24px)'\r\n\t\t\tthis._iframeNode.style.transition = value ? 'opacity 0.36s cubic-bezier(0.22, 1, 0.36, 1), transform 0.36s cubic-bezier(0.22, 1, 0.36, 1)' : 'opacity 0.1s ease, transform 0.1s ease, z-index 0s linear 0.1s'\r\n\t\t}\r\n\t}\r\n\tget usePopup() { return this._usePopup }\r\n\tprivate setUsePopup(value: boolean) {\r\n\t\tif (value === this._usePopup) { return }\r\n\t\tthis._usePopup = value\r\n\t\tthis.emit('builtin', { usePopup: value })\r\n\t}\r\n\tget requirePopup() { return this._requirePopup }\r\n\tprivate setRequirePopup(value: boolean) {\r\n\t\tif (value === this._requirePopup) { return }\r\n\t\tthis._requirePopup = value\r\n\t\tthis.emit('builtin', { requirePopup: value })\r\n\t}\r\n\tget keepPopup() { return this._keepPopup }\r\n\tset keepPopup(value) {\r\n\t\tthis._keepPopup = value\r\n\t\tthis.emit('builtin', { keepPopup: value })\r\n\t\tif (!value) { this.closePopup() }\r\n\t\tif (value) { this.openPopup(true) }\r\n\t}\r\n\r\n\r\n\r\n\tconstructor(connectToUrl: URL, appInfo?: AppInfo) {\r\n\t\tsuper()\r\n\t\tthis._iframeParentNode = appInfo?.iframeParentNode\r\n\t\tthis._url = connectToUrl\r\n\t\tconst urlInfo = {\r\n\t\t\torigin: window.location.origin,\r\n\t\t\tsession: Math.random().toString().slice(2)\r\n\t\t} as any\r\n\t\tif (appInfo?.name) { urlInfo.name = appInfo.name }\r\n\t\tif (appInfo?.logo) { urlInfo.logo = appInfo.logo }\r\n\t\tthis._url.hash = new URLSearchParams(urlInfo).toString()\r\n\t\twindow.addEventListener('message', this.listener)\r\n\t}\r\n\r\n\tdestructor(options?: object) {\r\n\t\tthis.closeIframe()\r\n\t\tthis.closePopup(true)\r\n\t\twindow.removeEventListener('message', this.listener)\r\n\t}\r\n\r\n\r\n\r\n\tprivate listener = (e: MessageEvent) => {\r\n\t\tif (e.source !== this._popup.window && e.source !== this._iframe?.window) { return }\r\n\t\tif (e.origin !== this._url?.origin) { return }\r\n\t\tif (typeof e.data !== 'object') { return }\r\n\t\tconst { method, params, id, result, error, session } = e.data as { [key: string]: unknown }\r\n\t\tconsole.info(`WalletConnector:${e.source === this._popup.window ? 'popup' : 'iframe'}`, e.data)\r\n\t\tif (id != null) { this._pending = this._pending.filter(x => x != id) }\r\n\t\tif (this._promiseController.processResponse(e.data)) { return }\r\n\t\tif (typeof method !== 'string') { return }\r\n\r\n\t\t// reserved methods\r\n\t\tif (method === 'ready') {\r\n\t\t\tif (e.source === this._popup.window) { this._popup.resolve?.() }\r\n\t\t\tif (e.source === this._iframe.window) { this._iframe.resolve?.() }\r\n\t\t\treturn\r\n\t\t}\r\n\t\tif (method === 'change') { return }\r\n\r\n\t\t// verified methods\r\n\t\tif (method === 'showIframe') {\r\n\t\t\tif (typeof params !== 'boolean') { return }\r\n\t\t\tthis.showIframe = params\r\n\t\t}\r\n\t\tif (method === 'usePopup') {\r\n\t\t\tif (typeof params !== 'boolean') { return }\r\n\t\t\tthis.setUsePopup(params)\r\n\t\t}\r\n\t\tif (method === 'keepPopup') {\r\n\t\t\tif (typeof params !== 'boolean') { return }\r\n\t\t\tthis.setRequirePopup(params)\r\n\t\t}\r\n\t\tconst emitting = { method, params, session }\r\n\t\tif (!is<Emitting['message']>(emitting)) { return console.warn('dropped') }\r\n\t\tthis.emit('message', emitting)\r\n\t}\r\n\r\n\r\n\r\n\tpostMessage(message: object, options?: PostMessageOptions) {\r\n\t\tconst promise = this._promiseController.newMessagePromise(message, options).finally(() => this.completeRequest())\r\n\t\tthis.deliverMessage(message)\r\n\t\treturn promise\r\n\t}\r\n\r\n\tprivate openIframe() {\r\n\t\tif (this._iframeEl) { return }\r\n\t\tthis._iframeNode = document.createElement('div')\r\n\t\tthis._iframeEl = document.createElement('iframe')\r\n\t\tthis._iframeEl.src = this._url.toString()\r\n\t\tthis._iframeEl.allow = 'usb; hid; bluetooth; serial; camera; payment; web-share'\r\n\t\tthis._iframeEl.style.border = 'none'\r\n\t\tif (!this._iframeParentNode) {\r\n\t\t\tthis._iframeEl.width = WIDTH\r\n\t\t\tthis._iframeEl.height = HEIGHT\r\n\t\t\tthis._iframeEl.style.borderRadius = '8px'\r\n\t\t\tthis._iframeEl.style.maxWidth = '100%'\r\n\t\t\tthis._iframeEl.style.maxHeight = '100%'\r\n\t\t\tthis._iframeNode.style.position = 'fixed'\r\n\t\t\tthis._iframeNode.style.inset = '0'\r\n\t\t\tthis._iframeNode.style.display = 'flex'\r\n\t\t\tthis._iframeNode.style.alignItems = 'center'\r\n\t\t\tthis._iframeNode.style.justifyContent = 'center'\r\n\t\t\tthis._iframeNode.style.background = '#00000088'\r\n\t\t\tthis._iframeNode.style.opacity = '0'\r\n\t\t\tthis._iframeNode.style.pointerEvents = 'none'\r\n\t\t\tthis._iframeNode.style.touchAction = 'none'\r\n\t\t\tthis._iframeNode.style.zIndex = '-1000000'\r\n\t\t\tthis._iframeNode.style.transform = 'translate(0, 24px)'\r\n\t\t\tthis._iframeNode.style.transition = 'opacity 0.1s ease, transform 0.1s ease, z-index 0s linear 0.1s'\r\n\t\t}\r\n\t\tthis._iframeNode.appendChild(this._iframeEl)\r\n\t\tconst promise = new Promise((resolve, reject) => this._iframe = { resolve, reject })\r\n\t\tthis._iframe.promise = promise\r\n\t\tconst injectIframe = () => {\r\n\t\t\tif (this._iframeParentNode) { this._iframeParentNode.appendChild(this._iframeNode!) }\r\n\t\t\telse { document.body.appendChild(this._iframeNode!) }\r\n\t\t\tthis._iframe.window = this._iframeEl?.contentWindow\r\n\t\t}\r\n\t\tif (document.readyState === 'complete' || document.readyState === 'interactive') { injectIframe() }\r\n\t\telse { document.addEventListener('DOMContentLoaded', injectIframe) }\r\n\t}\r\n\r\n\tprivate closeIframe() {\r\n\t\tthis._iframeEl?.setAttribute('src', 'about:blank')\r\n\t\tthis._iframeNode?.remove()\r\n\t\tthis._iframeNode = undefined\r\n\t\tthis._iframeEl = undefined\r\n\t\tthis._iframe.reject?.()\r\n\t\tthis._iframe = {}\r\n\t}\r\n\r\n\tprivate openPopup(force?: boolean) {\r\n\t\tif (this._popup.window && !this._popup.window.closed) { this._popup.window.focus(); return }\r\n\t\tif (!this.usePopup && !force) { return }\r\n\t\twindow.name = 'parent'\r\n\t\tconst popupWindow = window.open(this._url.toString(), '_blank', `location,resizable,scrollbars,width=${WIDTH},height=${HEIGHT}`)\r\n\t\tconst promise = new Promise((resolve, reject) => this._popup = { window: popupWindow, resolve, reject })\r\n\t\tthis._popup.promise = promise\r\n\t\tconst timer = setInterval(() => {\r\n\t\t\tif (this._popup.window && !this._popup.window.closed) { return }\r\n\t\t\tif (this.keepPopup) { this.keepPopup = false }\r\n\t\t\tclearInterval(timer)\r\n\t\t}, 200)\r\n\t}\r\n\r\n\tprivate closePopup(force?: boolean) {\r\n\t\tif (!this._popup.window || this._popup.window?.closed) { return }\r\n\t\t// todo test multiple instances behavior\r\n\t\t// todo if keepPopup -> might require a return back to prev page if on mobile\r\n\t\tif ((this.keepPopup || this.requirePopup) && !force) { return }\r\n\t\tthis._popup.window.location.href = 'about:blank'\r\n\t\tthis._popup.window.close()\r\n\t\tthis._popup.reject?.()\r\n\t\tthis._popup = {}\r\n\t}\r\n\r\n\tcompleteRequest() { setTimeout(() => {\r\n\t\tif (this._pending.length) { return }\r\n\t\tthis.closePopup()\r\n\t\tthis.showIframe = false\r\n\t}, 100)}\r\n\r\n\tdeliverMessage(message: any, options?: PostMessageOptions) {\r\n\t\tif (!this._url) { throw 'Missing URL' }\r\n\t\tconsole.info(`WalletConnector:post`, message)\r\n\t\tconst fullMessage = { ...message, jsonrpc: '2.0' }\r\n\t\tfullMessage.id != null && this._pending.push(fullMessage.id)\r\n\t\tthis.openIframe()\r\n\t\tthis._iframe.promise = this._iframe.promise\r\n\t\t\t?.then(() => this._iframe.window?.postMessage(fullMessage, this._url.origin, options?.transfer ? [fullMessage] : undefined))\r\n\t\t\t.catch(() => { return })\r\n\t\tthis.openPopup()\r\n\t\tthis._popup.promise = this._popup.promise\r\n\t\t\t?.then(() => this._popup.window?.postMessage(fullMessage, this._url.origin, options?.transfer ? [fullMessage] : undefined))\r\n\t\t\t.catch(() => { return })\r\n\t}\r\n}\r\n"]}